name: traffic-dumper-build

on:
    push:
        branches: ["**"]
        paths:
            - '.github/workflows/traffic-dumper-build.yml'
            - 'dockerfiles/Dockerfile.dpdk'
            - 'lumina/roce-pkt-dump/**'

    pull_request:
        branches: ["**"]
        paths:
            - '.github/workflows/traffic-dumper-build.yml'
            - 'dockerfiles/Dockerfile.dpdk'
            - 'lumina/roce-pkt-dump/**'

env:
    DOCKER_IMAGE_NAME: docker-ubuntu-with-dpdk

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v2

            - name: Build Docker image with DPDK installed
              run: |
                if ["$USER" -eq ""]; then
                    USER=$(id -un)
                fi
                if [ "$UID" -eq 0 ]; then
                    UID=$(id -u)
                fi
                if [ "$GUID" -eq 0 ]; then
                    GUID=$(id -g)
                fi
                docker build -t $DOCKER_IMAGE_NAME \
                    -f dockerfiles/Dockerfile.dpdk \
                    --build-arg USER="$USER" \
                    --build-arg UID="$UID" \
                    --build-arg GUID="$GUID" \
                    .

            - name: Start Docker container and build traffic dumper
              run: |
                docker run --rm \
                    -v ./lumina/roce-pkt-dump:/home/$USER/roce-pkt-dump \
                    $DOCKER_IMAGE_NAME \
                    bash -c \
                    "cd /home/$USER/roce-pkt-dump; make clean; make"
